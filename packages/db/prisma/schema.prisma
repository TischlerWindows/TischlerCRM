generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// User Management
// ============================================
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String?
  name         String?
  role         String   @default("USER")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  createdObjects      CustomObject[]  @relation("CreatedObjects")
  modifiedObjects     CustomObject[]  @relation("ModifiedObjects")
  createdFields       CustomField[]   @relation("CreatedFields")
  modifiedFields      CustomField[]   @relation("ModifiedFields")
  createdLayouts      PageLayout[]    @relation("CreatedLayouts")
  modifiedLayouts     PageLayout[]    @relation("ModifiedLayouts")
  createdRecords      Record[]        @relation("CreatedRecords")
  modifiedRecords     Record[]        @relation("ModifiedRecords")
  createdReports      Report[]        @relation("CreatedReports")
  modifiedReports     Report[]        @relation("ModifiedReports")
  createdFolders      ReportFolder[]  @relation("CreatedFolders")
  modifiedFolders     ReportFolder[]  @relation("ModifiedFolders")
  createdDashboards   Dashboard[]     @relation("CreatedDashboards")
  modifiedDashboards  Dashboard[]     @relation("ModifiedDashboards")
  loginEvents         LoginEvent[]
}

model LoginEvent {
  id         String   @id @default(uuid())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String
  accountId  String?
  ip         String
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([accountId])
  @@index([createdAt])
}

// ============================================
// Schema/Metadata Models (Custom Objects & Fields)
// ============================================

model CustomObject {
  id              String   @id @default(uuid())
  apiName         String   @unique
  label           String
  pluralLabel     String
  description     String?
  isCustom        Boolean  @default(true)
  isActive        Boolean  @default(true)
  enableHistory   Boolean  @default(false)
  enableSearch    Boolean  @default(true)
  
  createdBy       User     @relation("CreatedObjects", fields: [createdById], references: [id])
  createdById     String
  modifiedBy      User     @relation("ModifiedObjects", fields: [modifiedById], references: [id])
  modifiedById    String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  fields          CustomField[]
  pageLayouts     PageLayout[]
  records         Record[]
  relationships   Relationship[] @relation("ParentObject")
  childRelations  Relationship[] @relation("ChildObject")

  @@index([apiName])
}

model CustomField {
  id              String   @id @default(uuid())
  object          CustomObject @relation(fields: [objectId], references: [id], onDelete: Cascade)
  objectId        String
  
  apiName         String
  label           String
  type            String   // Text, Number, Currency, Date, DateTime, Checkbox, Picklist, etc.
  description     String?
  helpText        String?
  
  // Field constraints
  required        Boolean  @default(false)
  unique          Boolean  @default(false)
  readOnly        Boolean  @default(false)
  
  // Length/Size constraints
  maxLength       Int?
  minLength       Int?
  
  // Number constraints
  scale           Int?     // Decimal places
  precision       Int?     // Total digits
  min             Float?
  max             Float?
  
  // Picklist values (JSON array)
  picklistValues  Json?
  
  // Default value
  defaultValue    String?
  
  // Relationship info (for Lookup fields)
  relationshipId  String?  @unique
  
  isCustom        Boolean  @default(true)
  isActive        Boolean  @default(true)
  
  createdBy       User     @relation("CreatedFields", fields: [createdById], references: [id])
  createdById     String
  modifiedBy      User     @relation("ModifiedFields", fields: [modifiedById], references: [id])
  modifiedById    String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  relationship    Relationship? @relation("FieldRelationship")
  layoutFields    LayoutField[]

  @@unique([objectId, apiName])
  @@index([objectId])
  @@index([type])
}

model Relationship {
  id                String   @id @default(uuid())
  
  parentObject      CustomObject @relation("ParentObject", fields: [parentObjectId], references: [id], onDelete: Cascade)
  parentObjectId    String
  
  childObject       CustomObject @relation("ChildObject", fields: [childObjectId], references: [id], onDelete: Cascade)
  childObjectId     String
  
  field             CustomField @relation("FieldRelationship", fields: [fieldId], references: [id], onDelete: Cascade)
  fieldId           String      @unique
  
  relationshipName  String
  type              String      // Lookup, MasterDetail
  cascadeDelete     Boolean     @default(false)
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([parentObjectId])
  @@index([childObjectId])
}

// ============================================
// Page Layouts (UI Configuration)
// ============================================

model PageLayout {
  id              String   @id @default(uuid())
  object          CustomObject @relation(fields: [objectId], references: [id], onDelete: Cascade)
  objectId        String
  
  name            String
  layoutType      String   // 'edit' (used for both create and edit now)
  isDefault       Boolean  @default(false)
  isActive        Boolean  @default(true)
  
  createdBy       User     @relation("CreatedLayouts", fields: [createdById], references: [id])
  createdById     String
  modifiedBy      User     @relation("ModifiedLayouts", fields: [modifiedById], references: [id])
  modifiedById    String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tabs            LayoutTab[]

  @@index([objectId])
  @@index([layoutType])
}

model LayoutTab {
  id              String   @id @default(uuid())
  layout          PageLayout @relation(fields: [layoutId], references: [id], onDelete: Cascade)
  layoutId        String
  
  label           String
  order           Int      @default(0)
  
  sections        LayoutSection[]

  @@index([layoutId])
}

model LayoutSection {
  id              String   @id @default(uuid())
  tab             LayoutTab @relation(fields: [tabId], references: [id], onDelete: Cascade)
  tabId           String
  
  label           String
  columns         Int      @default(2)
  order           Int      @default(0)
  
  fields          LayoutField[]

  @@index([tabId])
}

model LayoutField {
  id              String   @id @default(uuid())
  section         LayoutSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  sectionId       String
  
  field           CustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  fieldId         String
  
  column          Int      @default(0)
  order           Int      @default(0)

  @@index([sectionId])
  @@index([fieldId])
}

// ============================================
// Dynamic Records (Actual Data)
// ============================================

model Record {
  id              String   @id @default(uuid())
  object          CustomObject @relation(fields: [objectId], references: [id], onDelete: Cascade)
  objectId        String
  
  // Store all field values as JSON
  data            Json     @default("{}")
  
  // System fields
  createdBy       User     @relation("CreatedRecords", fields: [createdById], references: [id])
  createdById     String
  modifiedBy      User     @relation("ModifiedRecords", fields: [modifiedById], references: [id])
  modifiedById    String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([objectId])
  @@index([createdAt])
  @@index([updatedAt])
}

// ============================================
// Reports & Analytics
// ============================================

model Report {
  id              String   @id @default(uuid())
  name            String
  description     String?
  objectType      String   // properties, contacts, accounts, etc.
  format          String   // tabular, summary, matrix
  
  // Report configuration
  fields          Json     // Array of field names to display
  filters         Json     // Array of filter objects
  groupBy         String?  // Field to group by (for summary/matrix)
  sortBy          String?  // Field to sort by
  sortOrder       String?  // asc or desc
  
  // Permissions and sharing
  isStandard      Boolean  @default(false)
  isPrivate       Boolean  @default(false)
  sharedWith      Json?    // Array of user emails/IDs
  isFavorite      Boolean  @default(false)
  
  // Folder organization
  folderId        String?
  folder          ReportFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)
  
  // Audit fields
  createdBy       User     @relation("CreatedReports", fields: [createdById], references: [id])
  createdById     String
  modifiedBy      User     @relation("ModifiedReports", fields: [modifiedById], references: [id])
  modifiedById    String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([objectType])
  @@index([format])
  @@index([createdById])
  @@index([folderId])
  @@index([isPrivate])
  @@index([isFavorite])
}

model ReportFolder {
  id              String   @id @default(uuid())
  name            String
  description     String?
  parentId        String?
  parent          ReportFolder? @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children        ReportFolder[] @relation("FolderHierarchy")
  
  // Permissions
  isPrivate       Boolean  @default(false)
  sharedWith      Json?    // Array of user emails/IDs
  
  // Audit fields
  createdBy       User     @relation("CreatedFolders", fields: [createdById], references: [id])
  createdById     String
  modifiedBy      User     @relation("ModifiedFolders", fields: [modifiedById], references: [id])
  modifiedById    String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  reports         Report[]

  @@index([createdById])
  @@index([parentId])
}

// ============================================
// Dashboards
// ============================================

model Dashboard {
  id              String   @id @default(uuid())
  name            String
  description     String?
  
  // Permissions and sharing
  isPrivate       Boolean  @default(false)
  isFavorite      Boolean  @default(false)
  sharedWith      Json?    // Array of user emails/IDs
  
  // Audit fields
  createdBy       User     @relation("CreatedDashboards", fields: [createdById], references: [id])
  createdById     String
  modifiedBy      User     @relation("ModifiedDashboards", fields: [modifiedById], references: [id])
  modifiedById    String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  widgets         DashboardWidget[]

  @@index([createdById])
  @@index([isFavorite])
  @@index([isPrivate])
}

model DashboardWidget {
  id              String   @id @default(uuid())
  dashboard       Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  dashboardId     String
  
  type            String   // 'vertical-bar', 'horizontal-bar', 'line', 'donut', 'metric', etc.
  title           String
  reportId        String?  // Optional reference to a Report
  dataSource      String   // Object type (e.g., 'accounts', 'contacts')
  
  // Widget configuration stored as JSON
  config          Json     @default("{}")
  
  // Position and size (grid coordinates)
  positionX       Int      @default(0)
  positionY       Int      @default(0)
  width           Int      @default(4)
  height          Int      @default(2)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([dashboardId])
}
